<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨˜äº‹å…¥åŠ›ãƒ»ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ </title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Quill Editor CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/minisearch@6.3.0/dist/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/takuyaa/tiny-segmenter/TinySegmenter.js"></script>
  <style>
    /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼ˆTailwindãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
    body { font-family: 'Inter', sans-serif; }
    
    /* Quillã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¿®æ­£ */
    #quillEditor-container {
      border: 1px solid #ddd;
      border-radius: 5px;
      min-height: 500px; /* å›ºå®šé«˜ã•ã‚’æœ€å°é«˜ã•ã«å¤‰æ›´ */
      overflow-y: hidden;
      display: flex;
      flex-direction: column;
      background-color: white;
    }
    .ql-toolbar.ql-snow {
      border: none;
      border-bottom: 1px solid #ddd;
      flex-shrink: 0;
      position: sticky;
      top: 0;
      background-color: #fff;
      z-index: 10;
    }
    .ql-container.ql-snow {
      border: none;
      flex-grow: 1;
      overflow-y: auto;
    }
   .ql-editor {
  min-height: 440px;
  font-size: 16px;
  line-height: 1.7;
  white-space: pre-wrap;      /* fallback */
  white-space: break-spaces;  /* é€£ç¶š/è¡Œæœ«ã‚¹ãƒšãƒ¼ã‚¹ã‚‚ä¿æŒ */
}
/* â† ã“ã‚Œã‚’è¿½åŠ ï¼ˆinheritã§å–ã‚Šã“ã¼ã—é˜²æ­¢ï¼‰ */
.ql-editor * {
  white-space: inherit;
}


    .form-group.checkbox-group > div {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #previewContent-container {
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 800px;
      margin: auto;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 30px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
      line-height: 1;
    }
    .close-button:hover {
      color: #555;
    }
    #previewTitle {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
      text-align: center;
    }
    .preview-subtitle {
      font-size: 20px;
      font-weight: 500;
      color: #666;
      margin: 0;
      text-align: center;
    }
    #previewContent {
      margin-top: 20px;
      line-height: 1.7;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    #previewContent img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 20px auto;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #previewContent p {
      margin-bottom: 1em;
    }

/* Quill toolbar ã®ç¤¾å†…ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºèª¿æ•´ */
.ql-toolbar .ql-internal {
  font-size: 12px;
  padding: 2px 6px;
  white-space: nowrap;       /* æ–‡å­—ã‚’æŠ˜ã‚Šè¿”ã•ãªã„ */
  height: 28px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}


    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-content {
      background-color: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 500px;
    }
    #multipleCategoryModal .modal-content {
      max-width: 600px;
    }
    #categoryListUl {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    #categoryListUl li {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

/* ã‚«ãƒ†ã‚´ãƒªé¸æŠã‚¨ãƒªã‚¢ã‚’ç„¡åŠ¹åŒ–ã—ãŸã¨ãã®è¦‹ãŸç›® */
#category-selection-window.is-disabled {
  pointer-events: none;
  opacity: 0.6;
}

/* Quill ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆæ‰“ã¡å§‹ã‚ã‚‹ã¨æ¶ˆãˆã‚‹è–„ã‚°ãƒ¬ãƒ¼ï¼‰ */
.ql-editor.ql-blank::before {
  color: #9CA3AF;  /* Tailwindã®gray-400 ç›¸å½“ */
  opacity: 1;
}


  </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex justify-center items-start">
  <div class="form-container bg-white p-6 rounded-xl shadow-2xl w-full max-w-4xl mx-auto my-8">
    <h2 class="text-3xl font-extrabold text-center text-gray-800 mb-6 border-b-2 pb-2">è¨˜äº‹å…¥åŠ›ãƒ»ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ </h2>
    <div class="text-sm text-gray-500 mb-4 text-right">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (åŒ¿å): <span id="currentUserId">èªè¨¼ä¸­...</span></div>

    <!-- GitHub ãƒˆãƒ¼ã‚¯ãƒ³å…¥åŠ›æ¬„ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼‰ -->
    <div class="form-group mb-4 border rounded-lg p-3 bg-gray-50">
      <label class="block font-semibold text-gray-700 mb-1">
        GitHub ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆPATï¼‰<span class="text-xs text-gray-500 ml-1">â€»ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã«ä¿å­˜ã•ã‚Œã¾ã™</span>
      </label>
      <div class="flex gap-2">
        <input
          type="password"
          id="githubTokenInput"
          placeholder="ghp_ ã‹ã‚‰å§‹ã¾ã‚‹ Personal Access Token"
          class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:outline-none bg-white shadow-sm"
        >
        <button
          type="button"
          onclick="window.saveGithubToken()"
          class="px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow hover:bg-indigo-700 transition"
        >
          ä¿å­˜
        </button>
      </div>
      <p class="text-xs text-gray-500 mt-1">
        â€» ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ã¯ä¿å­˜ã›ãšã€ãƒ–ãƒ©ã‚¦ã‚¶ã® localStorageï¼ˆ<code>kjd_github_pat</code>ï¼‰ã«ã®ã¿ä¿å­˜ã—ã¾ã™ã€‚
      </p>
    </div>


<div class="form-group mb-4">
  <label class="block font-semibold text-gray-700 mb-1">
    ãƒ­ãƒ¼ã‚«ãƒ« JSON ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆå†ç·¨é›†ç”¨ï¼‰
  </label>
  <input
    type="file"
    id="loadJsonFile"
    accept=".json"
    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:outline-none transition bg-white shadow-sm"
  >
</div>

    <div class="form-group mb-4">
      <label for="articleIdList" class="block font-semibold text-gray-700 mb-1">ç™»éŒ²æ¸ˆã¿è¨˜äº‹ã®èª­ã¿è¾¼ã¿</label>
      <select id="articleIdList" onchange="window.loadArticleForEdit(this.value)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:outline-none transition bg-white shadow-sm">
        <option value="">-- è¨˜äº‹ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
      </select>
    </div>

    <div class="form-group flex flex-col sm:flex-row gap-4 mb-4">
      <div class="flex-1">
        <label for="issue" class="block font-semibold text-gray-700 mb-1">å·æ•° <span class="text-red-500">*</span></label>
        <input type="text" id="issue" placeholder="ä¾‹: 0001 ã¾ãŸã¯ 'æ–°ç€è¨˜äº‹'" maxlength="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:outline-none transition shadow-sm">
      <div class="flex items-center gap-2 mt-2">
  <input type="checkbox" id="isNewArticle" class="rounded text-blue-600 border-gray-300 focus:ring-blue-500 h-5 w-5">
  <label for="isNewArticle" class="text-gray-700 font-medium select-none">æ–°ç€è¨˜äº‹</label>
</div></div>
      <div class="flex-1">
        <label for="sequence" class="block font-semibold text-gray-700 mb-1">æ²è¼‰é † <span class="text-red-500">*</span></label>
        <input type="text" id="sequence" placeholder="ä¾‹: 01" pattern="[0-9]{1,2}" maxlength="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:outline-none transition shadow-sm">
      </div>
      <div class="flex-1">
        <label for="publishDate" class="block font-semibold text-gray-700 mb-1">ç™ºè¡Œå¹´æœˆæ—¥ <span class="text-red-500">*</span></label>
        <input type="date" id="publishDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:outline-none transition shadow-sm">
      </div>
    </div>
    
    <div class="form-group mb-4">
      <label for="titleAndSubtitles" class="block font-semibold text-gray-700 mb-1">è¨˜äº‹è¦‹å‡ºã— / ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«1 / ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«2 <span class="text-red-500">*</span></label>
      <textarea id="titleAndSubtitles" placeholder="1è¡Œç›®: è¨˜äº‹è¦‹å‡ºã—ï¼ˆç™ºè¡Œä¸­æ­¢è¨˜äº‹ã®å ´åˆã¯ä¸­æ­¢ç†ç”±ï¼‰&#10;2è¡Œç›®: ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«1&#10;3è¡Œç›®: ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«2ã€€ã€€ã€ä»»æ„ã«æ”¹è¡Œã—ãŸã„å ´åˆã¯<br>ã‹\nã‚’å…¥ã‚Œã‚‹ã€‘" class="w-full p-3 border border-gray-300 rounded-lg h-24 resize-y focus:ring-4 focus:ring-blue-200 focus:outline-none transition shadow-sm"></textarea>
    </div>
    
    <div class="form-group flex flex-col sm:flex-row gap-4 mb-4">
      <div class="flex-1 relative">
        <label class="block font-semibold text-gray-700 mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
        <div class="flex gap-2">
          <div id="category-selection-window" onclick="window.openMultiCategoryModal()" class="flex-1 p-3 border border-gray-300 rounded-lg bg-white cursor-pointer min-h-12 transition hover:border-blue-400 shadow-sm flex flex-wrap items-center">
            <div id="selected-categories-display" class="text-gray-500 text-sm">-- ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ --</div>
          </div>
          <button onclick="window.openCategoryModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition shadow-md whitespace-nowrap">ã‚«ãƒ†ã‚´ãƒªç®¡ç†</button>
        </div>
      </div>
      <div class="flex-1">
        <label for="keywords" class="block font-semibold text-gray-700 mb-1">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
        <input
  type="text"
  id="keywords"
  placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›"
  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:outline-none transition shadow-sm"
  autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="kws"
/>

      </div>
    </div>
    
    <div class="form-group mb-4">
      <label for="quillEditor" class="block font-semibold text-gray-700 mb-1">è¨˜äº‹æœ¬æ–‡</label>
      <div id="quillEditor-container" class="shadow-md">
        <div id="quillEditor"></div>
      </div>
    </div>
    
    <div class="form-group checkbox-group flex justify-end gap-6 mt-4 pr-2">
  <div>
    <input type="checkbox" id="ä¾‹å¤–è¡¨ç¤º" class="rounded text-blue-600 border-gray-300 focus:ring-blue-500 h-5 w-5">
    <label for="ä¾‹å¤–è¡¨ç¤º" class="text-gray-700 font-medium select-none">ä¾‹å¤–è¡¨ç¤º (å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—)</label>
  </div>
  <div>
    <input type="checkbox" id="éè¡¨ç¤º" class="rounded text-blue-600 border-gray-300 focus:ring-blue-500 h-5 w-5">
    <label for="éè¡¨ç¤º" class="text-gray-700 font-medium select-none">éè¡¨ç¤º (å…¬é–‹ã‚µã‚¤ãƒˆã«è¡¨ç¤ºã—ãªã„)</label>
  </div>
</div>
    <div id="message" aria-live="polite" class="text-center text-blue-600 my-2 min-h-6 font-medium"></div>

    <div class="button-group flex gap-4 mt-6">
      <button id="saveButton" onclick="window.saveArticle()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition shadow-lg hover:shadow-xl disabled:bg-gray-400 disabled:cursor-not-allowed">è¨˜äº‹ã‚’ç™»éŒ²</button>
      <button id="updateButton" onclick="window.updateArticle()" disabled class="flex-1 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition shadow-lg hover:shadow-xl disabled:bg-gray-400 disabled:cursor-not-allowed">è¨˜äº‹ã‚’æ›´æ–°</button>
      <button onclick="window.previewArticle()" class="flex-1 bg-gray-500 text-white font-bold py-3 rounded-lg hover:bg-gray-600 transition shadow-lg hover:shadow-xl">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
      <button onclick="window.clearForm()" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition shadow-lg hover:shadow-xl">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <!-- ã‚«ãƒ†ã‚´ãƒªç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="categoryModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="text-2xl font-bold mb-4">ã‚«ãƒ†ã‚´ãƒªç®¡ç†</h3>
      <div class="flex mb-4">
        <input type="text" id="newCategoryName" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªå" class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:outline-none">
        <button onclick="window.addCategory()" class="px-4 py-2 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600 transition">è¿½åŠ </button>
      </div>
      <ul id="categoryListUl" class="mb-4">
        <!-- ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
      </ul>
      <button onclick="window.closeCategoryModal()" class="w-full py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- è¤‡æ•°ã‚«ãƒ†ã‚´ãƒªé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="multipleCategoryModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="text-2xl font-bold mb-4">ã‚«ãƒ†ã‚´ãƒªé¸æŠ</h3>
      <div id="multiCategoryCheckboxes" class="max-h-64 overflow-y-auto border p-3 rounded-lg grid grid-cols-2 gap-2">
        <!-- è¤‡æ•°ã‚«ãƒ†ã‚´ãƒªã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
      </div>
      <div class="mt-4 flex justify-end">
        <button onclick="window.applyMultiCategories()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition mr-2">é©ç”¨</button>
        <button onclick="window.closeMultiCategoryModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="previewArea" class="modal-overlay">
    <div id="previewContent-container">
      <span class="close-button" onclick="window.closePreview()">Ã—</span>
      <h1 id="previewTitle"></h1>
      <p id="previewSubtitles" class="preview-subtitle"></p>
      <div id="previewContent" class="ql-editor article-content"></div>
      <div class="text-center mt-6">
        <button onclick="window.closePreview()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Quill JS CDN -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <!-- è¨˜äº‹å…¥åŠ›ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆBIN æš—å·åŒ– + ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç† + GitHubé€£æºï¼‰ -->
  <script type="module">



  // â˜…ã“ã“ã« Cloudflare Worker å´ã¨å…±æœ‰ã™ã‚‹ 32byte ã‚­ãƒ¼ã‚’ Base64 ã§å…¥ã‚Œã‚‹
  //   â†’ ã¾ã æ±ºã‚ã¦ã„ãªã„é–“ã¯ã“ã®ãƒ€ãƒŸãƒ¼ã§ OKï¼ˆã“ã®å ´åˆ BIN ç”Ÿæˆã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œ JSON ã®ã¿ï¼‰
  const ENC_KEY_B64 = "MGU8z/MaR3nxnRoFIlIbzKdcCQHk8hPDuOqPNNIfkCU=";
  console.log("ENC_KEY_B64 =", ENC_KEY_B64);


// ===== GitHub ã®ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ï¼ˆGETï¼‰ =====
//   path: "_manifest.json" ãªã©
async function githubGetFile(path, token) {
  // ãƒ‘ã‚¹ã‚’ URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆ/ ã¯ãã®ã¾ã¾æ®‹ã™ï¼‰
  const encodedPath = encodeURIComponent(path).replace(/%2F/g, "/");
  const url = `${GITHUB_API_BASE}/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodedPath}?ref=${encodeURIComponent(GITHUB_BRANCH)}`;

  const res = await fetch(url, {
    headers: {
      Authorization: `Bearer ${token}`,
      Accept: "application/vnd.github+json"
    }
  });

  if (res.status === 404) {
    // ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡ã„ã¨ãã¯ null æ‰±ã„
    return null;
  }
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`GitHub GET å¤±æ•—: ${res.status} ${res.statusText} ${txt}`);
  }

  return await res.json(); // { content, sha, ... } ãŒè¿”ã£ã¦ãã‚‹
}


// ã‚µãƒ¼ãƒãƒ¼ä¸Šã® _manifest.json ã‚’ GitHub ã‹ã‚‰èª­ã¿è¾¼ã‚€
async function ensureManifestLoaded(force = false, token = undefined) {
  if (!force && manifestFiles.length > 0) return;

  try {
    const file = await githubGetFile("_manifest.json", token);
    if (!file) {
      console.warn("[MANIFEST] _manifest.json ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ï¼‰ã€‚");
      manifestFiles = [];
      manifestSha = null;
      return;
    }

    const rawB64 = (file.content || "").replace(/\n/g, "");
    const bin = atob(rawB64);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    const text = new TextDecoder().decode(bytes);

    const obj = JSON.parse(text);
    if (Array.isArray(obj.files)) {
      manifestFiles = obj.files.map(f => ({ ...f }));
      manifestSha   = file.sha || null;
      console.log("[MANIFEST] GitHub ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰:", manifestFiles.length, "ä»¶");
    } else {
      console.warn("[MANIFEST] files é…åˆ—ãŒç„¡ã„ã®ã§ç©ºã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚");
      manifestFiles = [];
      manifestSha   = file.sha || null;
    }
  } catch (e) {
    console.error("[MANIFEST] èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
    manifestFiles = [];
    manifestSha   = null;
  }
}

// è¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ manifest ç”¨ã®1ä»¶åˆ†ã‚’ä½œã‚‹
function buildManifestEntryFromArticle(slug, article) {
  return {
    slug: slug,
    title: article.title || "",
    publishDate: article.publishDate || "",
    categoryIds: Array.isArray(article.categoryIds) ? article.categoryIds.slice() : [],
    // å…¬é–‹ã‚µã‚¤ãƒˆç”¨ã®ãƒ‘ã‚¹ï¼ˆCloudflare/Hosting å´ã§ã¯ /build_plain_articles/... ã«ç½®ãæƒ³å®šï¼‰
    path: `/build_plain_articles/${encodeURIComponent(slug)}.json`,
    isHidden: !!article.isHidden,
    isNewArticle: !!article.isNewArticle
  };
}

// manifestFiles â†’ _manifest.json ã‚’ GitHub ã«ä¿å­˜
async function saveManifestToGitHub(token) {
  const obj = { files: manifestFiles };
  const text = JSON.stringify(obj, null, 2);
  const res = await githubUpsertText("_manifest.json", text, token, "Update _manifest.json", manifestSha);
  if (res && res.content && res.content.sha) {
    manifestSha = res.content.sha;
  }
}

// 1è¨˜äº‹ã¶ã‚“ã‚’ manifestFiles ã«è¿½åŠ /æ›´æ–° â†’ _manifest.json ã‚’ GitHub ã«ä¿å­˜
async function updateManifestForArticle(slug, article, token) {
  // ğŸ”¸ æ¯å› GitHub ã®æœ€æ–° _manifest.json ã‚’èª­ã‚“ã§ã‹ã‚‰å‡¦ç†
  //    forceReload = true ã«ã—ã¦ã€ä»–ã®äººã®ç·¨é›†ã¨ã‚‚ã‚ºãƒ¬ã«ããã™ã‚‹
  await ensureManifestLoaded(true, token);

  const entry = buildManifestEntryFromArticle(slug, article);

  // slug / articleId / id ã®ã©ã‚Œã‹ãŒä¸€è‡´ã™ã‚Œã°åŒã˜è¨˜äº‹ã¨ã¿ãªã™
  const key = String(slug);
  const idx = manifestFiles.findIndex(f => {
    const s = String(f.slug || "");
    const a = String(f.articleId || "");
    const i = String(f.id || "");
    return s === key || a === key || i === key;
  });

  if (idx >= 0) {
    manifestFiles[idx] = entry;
    console.log("[MANIFEST] æ›´æ–°:", slug);
  } else {
    manifestFiles.push(entry);
    console.log("[MANIFEST] è¿½åŠ :", slug);
  }

  await saveManifestToGitHub(token);
}


// manifestFiles ã‚’ JSON ãƒ†ã‚­ã‚¹ãƒˆåŒ–
function getManifestJsonText() {
  const obj = { files: manifestFiles };
  return JSON.stringify(obj, null, 2);
}

  // ======== Base64 å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========

  // Base64 â†’ Uint8Array
  function base64ToBytes(b64) {
    const bin = atob(b64);
    const len = bin.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) bytes[i] = bin.charCodeAt(i);
    return bytes;
  }

  // Uint8Array â†’ Base64
  function bytesToBase64(bytes) {
    let s = "";
    for (let i = 0; i < bytes.length; i++) s += String.fromCharCode(bytes[i]);
    return btoa(s);
  }


  // ======== GitHub é€£æºè¨­å®š & ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç† ========

  const GITHUB_OWNER  = "keizaij";   // â˜…ã“ã“ã« GitHub ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼/çµ„ç¹”å
  const GITHUB_REPO   = "kjdweb-data";      // â˜…ã“ã“ã« ãƒªãƒã‚¸ãƒˆãƒªå
  const GITHUB_BRANCH = "main";                // â˜…ä½¿ç”¨ãƒ–ãƒ©ãƒ³ãƒ
  const GITHUB_API_BASE = "https://api.github.com";
  const GITHUB_BASE_PATH = "";                      // ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã«ä¿å­˜ã™ã‚‹ãªã‚‰ç©º
  const GITHUB_TOKEN_STORAGE_KEY = "kjd_github_pat";

  // â˜…å…¨æ–‡æ¤œç´¢ç”¨ã®å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ç½®ããƒ‘ã‚¹
  const SEARCH_SOURCE_PATH = "build_plain_articles/_search_source.json";


// >>> ã“ã“ã«è¿½åŠ  <<<
let manifestFiles = [];
let manifestSha   = null;

  // ç”»é¢ã®ãƒˆãƒ¼ã‚¯ãƒ³å…¥åŠ›ã‚’ localStorage ã«ä¿å­˜
  window.saveGithubToken = function() {
    const input = document.getElementById("githubTokenInput");
    if (!input) return;
    const token = input.value.trim();
    if (!token) {
      alert("GitHub ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    localStorage.setItem(GITHUB_TOKEN_STORAGE_KEY, token);
    alert("GitHub ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿æœ‰åŠ¹ï¼‰");
    input.value = "";
  // â˜… ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜å¾Œã«è¨˜äº‹ä¸€è¦§ã‚‚æ›´æ–°
  refreshArticleIdList();
  };

  // ä¿å­˜ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
  function getGithubToken() {
    const token = localStorage.getItem(GITHUB_TOKEN_STORAGE_KEY);
    if (!token) {
      throw new Error("GitHub ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç”»é¢ä¸Šéƒ¨ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
    }
    return token;
  }

  // ãƒ†ã‚­ã‚¹ãƒˆ â†’ Base64
  function textToBase64(text) {
    const enc = new TextEncoder();
    const bytes = enc.encode(text);
    return bytesToBase64(bytes);
  }

  // GitHub ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ 1 ã¤ PUTï¼ˆcreate/updateï¼‰
  async function githubPutFile(token, path, base64Content, message) {
    if (!GITHUB_OWNER || !GITHUB_REPO) {
      throw new Error("GITHUB_OWNER / GITHUB_REPO ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚");
    }

    // ãƒ‘ã‚¹ã‚’ URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆ/ ã¯æ®‹ã™ï¼‰
    const encodedPath = encodeURIComponent(path).replace(/%2F/g, "/");
    const url = `${GITHUB_API_BASE}/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodedPath}`;

    // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã® sha ã‚’å–ã‚‹ï¼ˆãªã‘ã‚Œã° 404ï¼‰
    let sha = undefined;
    const getRes = await fetch(`${url}?ref=${encodeURIComponent(GITHUB_BRANCH)}`, {
      headers: {
        Authorization: `Bearer ${token}`,
        Accept: "application/vnd.github+json"
      }
    });
    if (getRes.ok) {
      const info = await getRes.json();
      sha = info.sha;
    } else if (getRes.status !== 404) {
      const txt = await getRes.text();
      throw new Error(`GitHub å–å¾—ã‚¨ãƒ©ãƒ¼ (${getRes.status}): ${txt}`);
    }

    const body = {
      message,
      content: base64Content,
      branch: GITHUB_BRANCH
    };
    if (sha) body.sha = sha;

    const putRes = await fetch(url, {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${token}`,
        Accept: "application/vnd.github+json",
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    if (!putRes.ok) {
      const txt = await putRes.text();
      throw new Error(`GitHub æ›´æ–°ã‚¨ãƒ©ãƒ¼ (${putRes.status}): ${txt}`);
    }
    return putRes.json();
  }

// ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã®è–„ã„ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆä¸Šã® githubPutFile ã‚’åˆ©ç”¨ï¼‰
async function githubUpsertText(path, text, token, message, prevSha) {
  // prevSha ã¯ä»Šå›ã®å®Ÿè£…ã§ã¯ä½¿ã‚ãªã„ï¼ˆç„¡è¦–ã—ã¦OKï¼‰
  const base64 = textToBase64(text);
  return githubPutFile(token, path, base64, message);
}


 

  // ======== BIN æš—å·åŒ– =========

  // æš—å·éµã‚’ WebCrypto ã« import
  let _encKeyPromise = null;
  function getEncryptKey() {
    if (!_encKeyPromise) {
      _encKeyPromise = (async () => {
        if (!ENC_KEY_B64 || ENC_KEY_B64 === "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=") {
          throw new Error("ENC_KEY_B64 ã«å®Ÿéš›ã®éµ(Base64)ã‚’è¨­å®šã—ã¦ãã ã•ã„");
        }
        const raw = base64ToBytes(ENC_KEY_B64);
        if (raw.byteLength !== 32) {
          throw new Error("æš—å·éµã¯ 32 ãƒã‚¤ãƒˆ (AES-256) ãŒå¿…è¦ã§ã™");
        }
        return crypto.subtle.importKey(
          "raw",
          raw,
          { name: "AES-GCM" },
          false,
          ["encrypt"]
        );
      })();
    }
    return _encKeyPromise;
  }

  // JSONæ–‡å­—åˆ—ã‚’ AES-GCM ã§æš—å·åŒ–ã—ã¦ BIN ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™
  // ä»•æ§˜: [IV(12B)][CT||TAG] ã‚’ Base64 ã«ã—ã¦è¿”ã™
  // AAD: "slug:<slug>"
  async function buildBinTextFromJson(slug, jsonText) {
    const key = await getEncryptKey();
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encoder = new TextEncoder();

    const aad = encoder.encode(`slug:${slug}`);
    const pt  = encoder.encode(jsonText);

    const ctBuf = await crypto.subtle.encrypt(
      {
        name: "AES-GCM",
        iv,
        additionalData: aad,
        tagLength: 128
      },
      key,
      pt
    );
    const ct = new Uint8Array(ctBuf);

    // [IV][CT||TAG] ã‚’é€£çµ
    const out = new Uint8Array(iv.length + ct.length);
    out.set(iv, 0);
    out.set(ct, iv.length);

    return bytesToBase64(out); // â˜… ã“ã‚Œã‚’ .bin ã®ä¸­èº«ã¨ã—ã¦ä¿å­˜
  }

  // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  function downloadTextFile(filename, text) {
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }


// è¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ JSON / BIN ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹
async function buildJsonAndBin(slug, article) {
  const jsonObj = {
    ...article,
    _exportedAt: new Date().toISOString(),
  };
  const jsonText = JSON.stringify(jsonObj, null, 2);

  let binText = null;
  if (!ENC_KEY_B64 || ENC_KEY_B64 === "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=") {
    console.warn("[BIN] ç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™: ENC_KEY_B64 ã«å®Ÿéš›ã®éµ(Base64)ã‚’è¨­å®šã—ã¦ãã ã•ã„");
  } else {
    binText = await buildBinTextFromJson(slug, jsonText);
  }

  return { jsonText, binText };
}




  // ===============================
  // 0. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  // ===============================
  let quill;
  let selectedCategoryIds = [];
  let currentArticleId = null;        // ã„ã¾ç·¨é›†ã—ã¦ã„ã‚‹è¨˜äº‹IDï¼ˆ215301 ã¨ã‹ NEW-...ï¼‰
  let currentArticleCreatedAt = null; // createdAt ã‚’ä¿æŒã—ã¦ãŠã


  // ===============================
  // 0-1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ†ã‚´ãƒªä¸€è¦§
  //   id  : è¨˜äº‹JSONã«å…¥ã£ã¦ã„ã‚‹ãƒ©ãƒ³ãƒ€ãƒ è‹±æ•°å­—
  //   name: ç”»é¢ã«å‡ºã—ãŸã„æ—¥æœ¬èªå
  //   order: è¡¨ç¤ºé †ï¼ˆå¾Œã§ä¸¦ã³æ›¿ãˆãŸã„ã¨ãã«ç•ªå·ã‚’å¤‰ãˆã‚Œã°OKï¼‰
  // ===============================
  const DEFAULT_CATEGORIES = [
    { id: "08jGjZRtfwpJNYhQsSWZ", name: "è‡ªå‹•è»Šé–¢é€£",           order:  1 },
    { id: "2a3wuMt8Tqbor2L9sVWT", name: "å°å£²é–¢é€£",             order:  2 },
    { id: "3Jnka8JGNSgSi66Py6zV", name: "ç«¶å£²ãƒ»å…¥æœ­é–¢é€£",       order:  3 },
    { id: "6CdvcxXCUWrstur5S0v9", name: "æ°´ç”£é–¢é€£",             order:  4 },
    { id: "ClD3hHhAXX7TUqRQXi46", name: "é£Ÿå“é–¢é€£",             order:  5 },
    { id: "EBFYEqC4TojaJJ30FGXz", name: "ä¼‘æ¥­ãƒ»æ’¤é€€é–¢é€£",       order:  6 },
    { id: "GzRRfI71G0BqPjtSAxS2", name: "æ–°ç¯‰ãƒ»æ”¹è£…ãƒ»ç§»è»¢é–¢é€£", order:  7 },
    { id: "S6ASodsOgpYDTatprCtj", name: "é‡‘èæ©Ÿé–¢é–¢é€£",         order:  8 },
    { id: "SNAkWpUGVGoqZ3YWFdoa", name: "åˆä½µãƒ»è­²æ¸¡é–¢é€£",       order:  9 },
    { id: "TAiWAvEryLMTfuhmCHVG", name: "å€’ç”£ãƒ»è§£æ•£é–¢é€£",       order: 10 },
    { id: "WYYSfTyL2iTtlNhtChdy", name: "å»ºç¯‰é–¢é€£",             order: 11 },
    { id: "XjjwdESm9TaSb754kVWF", name: "æ–°è¨­ãƒ»é€²å‡ºé–¢é€£",       order: 12 },
    { id: "eFpNNhhm3RaYBiqnHeC7", name: "ä¸å‹•ç”£é–¢é€£",           order: 13 },
    { id: "ntQlhvtZnywquyljKJXK", name: "é‹é€é–¢é€£",             order: 14 },
    { id: "qU1Lc6K9RZzDOzgY8RmF", name: "æ±ºç®—ãƒ»é‡‘èå•†å“é–¢é€£",   order: 15 },
    { id: "yiRqmTmfAsgFtktyxjNn", name: "ä½“åˆ¶å¤‰æ›´é–¢é€£",         order: 16 },
  ];

  // ===============================
  // 1. Quill åˆæœŸåŒ– & ç”»é¢åˆæœŸåŒ–
  // ===============================
  window.addEventListener('load', () => {
    initQuill();
    initFormLocks();
    loadCategoriesFromLocal();
    setupJsonImport();
    setupNewArticleCheckbox();
    setMessage('æ–°è¦è¨˜äº‹ã®å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚');
  // â˜… GitHub ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šæ¸ˆã¿ãªã‚‰ã€ç™»éŒ²æ¸ˆã¿è¨˜äº‹ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
  refreshArticleIdList();
  });

  function initQuill() {
    const el = document.getElementById('quillEditor');
    if (!el) return;

    quill = new Quill('#quillEditor', {
      theme: 'snow',
      placeholder: 'è¨˜äº‹æœ¬æ–‡ã‚’ã“ã“ã«å…¥åŠ›...',
      modules: {
        toolbar: [
          [{ header: [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ list: 'ordered' }, { list: 'bullet' }],
          [{ indent: '-1' }, { indent: '+1' }],
          [{ align: [] }],
          ['link', 'image'],
          ['clean']
        ]
      }
    });

    // Quill åˆæœŸåŒ–ç›´å¾Œã«ã€Œç¤¾å†…ãƒªãƒ³ã‚¯ã€ãƒœã‚¿ãƒ³ã ã‘ã¯æ®‹ã™
    const tb = document.querySelector('.ql-toolbar');
    if (tb) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'ql-internal';
      btn.textContent = 'ç¤¾å†…ãƒªãƒ³ã‚¯';
      btn.title = 'é¸æŠãƒ†ã‚­ã‚¹ãƒˆã‚’ç¤¾å†…è¨˜äº‹ãƒªãƒ³ã‚¯åŒ–';
      btn.addEventListener('click', () => {
        alert('ã„ã¾ã¯ãƒ­ãƒ¼ã‚«ãƒ«å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ãªã®ã§ã€Œç¤¾å†…ãƒªãƒ³ã‚¯ã€ã¯ã¾ã æœªå®Ÿè£…ã§ã™ã€‚å¾Œã§é™çš„ã‚µã‚¤ãƒˆå´ã«åˆã‚ã›ã¦è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚');
      });
      tb.appendChild(btn);
    }
  }

  function setMessage(msg, isError = false) {
    const m = document.getElementById('message');
    if (!m) return;
    m.textContent = msg;
    m.classList.toggle('text-blue-600', !isError);
    m.classList.toggle('text-red-600', isError);
  }

  // ===============================
  // 2. ãƒ•ã‚©ãƒ¼ãƒ ãƒ­ãƒƒã‚¯ç³»ï¼ˆæ–°ç€/ä¾‹å¤–/éè¡¨ç¤ºï¼‰
  // ===============================
  function setDisabledAttr(idOrEl, disabled) {
    const el = typeof idOrEl === 'string'
      ? document.getElementById(idOrEl)
      : idOrEl;
    if (!el) return;
    el.disabled = disabled;
    el.classList.toggle('bg-gray-100', disabled);
    el.classList.toggle('cursor-not-allowed', disabled);
  }

  function toggleCategoryUI(disabled) {
    const area = document.getElementById('category-selection-window');
    const btn  = document.querySelector('button[onclick="window.openCategoryModal()"]');
    if (area) area.classList.toggle('is-disabled', disabled);
    if (btn)  btn.disabled = disabled;
  }

  function toggleQuillEnabled(enabled) {
    if (!quill) return;
    quill.enable(enabled);
    quill.root.classList.toggle('bg-gray-100', !enabled);
    quill.root.classList.toggle('cursor-not-allowed', !enabled);
  }

  function toggleNewArticleUI(checked) {
    const issueEl = document.getElementById('issue');
    if (!issueEl) return;
    if (checked) {
      issueEl.value = '';
      issueEl.disabled = true;
      issueEl.classList.add('bg-gray-100', 'cursor-not-allowed');
      issueEl.placeholder = 'ï¼ˆæ–°ç€ã®ãŸã‚ç©ºæ¬„ã§OKï¼‰';
    } else {
      issueEl.disabled = false;
      issueEl.classList.remove('bg-gray-100', 'cursor-not-allowed');
      issueEl.placeholder = 'ä¾‹: 0001';
    }
  }

  function applyFormLocks() {
    const isNew = document.getElementById('isNewArticle').checked;
    const isEx  = document.getElementById('ä¾‹å¤–è¡¨ç¤º').checked;

    // å·æ•°ï¼šæ–°ç€ã®ã¨ãå…¥åŠ›ä¸å¯
    setDisabledAttr('issue', isNew);

    // æ²è¼‰é †ï¼šæ–°ç€ or ä¾‹å¤– ã®ã¨ãå…¥åŠ›ä¸å¯
    const seqDisabled = isNew || isEx;
    setDisabledAttr('sequence', seqDisabled);
    if (seqDisabled) {
      const seqEl = document.getElementById('sequence');
      if (seqEl) seqEl.value = '';
    }

    // ã‚«ãƒ†ã‚´ãƒªï¼†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼šæ–°ç€ or ä¾‹å¤– ã®ã¨ãæ“ä½œä¸å¯
    const metaDisabled = isNew || isEx;
    toggleCategoryUI(metaDisabled);
    setDisabledAttr('keywords', metaDisabled);
    if (metaDisabled) {
      const kwEl = document.getElementById('keywords');
      if (kwEl) kwEl.value = '';
    }

    // æœ¬æ–‡ï¼šä¾‹å¤–ã®ã¨ãã®ã¿èª­ã¿å–ã‚Šå°‚ç”¨
    toggleQuillEnabled(!isEx);
  }

  function initFormLocks() {
    const isNewCb = document.getElementById('isNewArticle');
    const exceptionalCb = document.getElementById('ä¾‹å¤–è¡¨ç¤º');

    if (isNewCb) {
      isNewCb.addEventListener('change', (e) => {
        toggleNewArticleUI(e.target.checked);
        applyFormLocks();
      });
    }
    if (exceptionalCb) {
      exceptionalCb.addEventListener('change', () => applyFormLocks());
    }

    applyFormLocks();
  }

  function setupNewArticleCheckbox() {
    const isNewCb = document.getElementById('isNewArticle');
    if (!isNewCb) return;
    // åˆæœŸçŠ¶æ…‹ã¯ã€Œé€šå¸¸è¨˜äº‹ã€ã¨ã—ã¦æ‰±ã†
    isNewCb.checked = false;
    toggleNewArticleUI(false);
    applyFormLocks();
  }

  // ===============================
  // 3. Quill HTML â†’ ä¿å­˜ç”¨ HTML
  // ===============================
  const ARTICLE_STYLE = `<style>
    .ql-align-center{text-align:center;}
    .ql-align-right{text-align:right;}
    .ql-align-justify{text-align:justify;}
    .ql-font-serif{font-family:serif;}
    .ql-font-monospace{font-family:monospace;}
    .ql-size-small{font-size:0.75em;}
    .ql-size-large{font-size:1.5em;}
    .ql-size-huge{font-size:2.5em;}
    .article-content{
      white-space: pre-wrap;
      white-space: break-spaces;
    }
    .article-content img{
      max-width:100%;
      height:auto;
      display:block;
      margin:10px auto;
    }
  </style>`;

  // â˜… Quillã‹ã‚‰å‡ºã¦ããŸ HTML å†…ã® data:image ã‚’ /photo/... ã«å·®ã—æ›¿ãˆã¤ã¤ã€
  //   ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ GitHub ã«ã‚¢ãƒƒãƒ—ã™ã‚‹ãŸã‚ã® base64 ä¸€è¦§ã‚’è¿”ã™
  function processInlineImages(issue, slug, html) {
    if (!html || typeof html !== "string") {
      return { html: html || "", imageFiles: [] };
    }

    // å…ƒHTMLå…ˆé ­ã«ã‚ã‚‹ <style> ã‚’ä¿æŒã—ã¦ãŠã
    const styleMatch = html.match(/^\s*<style[\s\S]*?<\/style>/i);
    const stylePart = styleMatch ? styleMatch[0] : "";
    const htmlWithoutStyle = styleMatch ? html.replace(styleMatch[0], "") : html;

    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlWithoutStyle, "text/html");
    const body = doc.body;

    const imgs = Array.from(body.querySelectorAll("img"));
    const files = [];
    let index = 1;

    const issueFolderRaw = (issue || "").trim();
    const issueFolder = issueFolderRaw
      ? (issueFolderRaw.replace(/[^\dA-Za-z_-]/g, "") || issueFolderRaw)
      : slug; // æ–°ç€ãªã©å·æ•°ãªã—ã®å ´åˆã¯ slug ãƒ•ã‚©ãƒ«ãƒ€ã«

    imgs.forEach(img => {
      const src = img.getAttribute("src") || "";
      if (!src.startsWith("data:image/")) return;

      const m = src.match(/^data:image\/(png|jpe?g|gif);base64,(.+)$/i);
      if (!m) return;

      const ext = (m[1].toLowerCase() === "jpeg") ? "jpg" : m[1].toLowerCase();
      const b64 = m[2];

      const numStr   = String(index).padStart(2, "0");
      const fileName = `${slug}-${numStr}.${ext}`;
      const repoPath = `photo/${issueFolder}/${fileName}`;
      const urlPath  = `/photo/${issueFolder}/${fileName}`;

      // HTMLå´ã¯ /photo/... ã«å·®ã—æ›¿ãˆ
      img.setAttribute("src", urlPath);

      files.push({
        path: repoPath,
        contentBase64: b64,
      });

      index++;
    });

    const bodyHtml = body.innerHTML;
    const finalHtml = stylePart + bodyHtml;

    return {
      html: finalHtml,
      imageFiles: files,
    };
  }

  function normalizeLeadingSpacesInBlocks(html) {
    const wrapper = document.createElement('div');
    wrapper.innerHTML = html;

    const blocks = wrapper.querySelectorAll('p, li, h1, h2, h3, h4, h5, h6, blockquote');
    blocks.forEach(block => {
      const walker = document.createTreeWalker(block, NodeFilter.SHOW_TEXT, null);
      while (walker.nextNode()) {
        const node = walker.currentNode;
        if (!node.nodeValue) continue;

        const v = node.nodeValue;
        const zwPrefix = (v.match(/^[\u200B\uFEFF]*/)||[''])[0];
        const rest = v.slice(zwPrefix.length);

        const m = rest.match(/^[ \u3000]+/);
        if (m) {
          const converted = rest.replace(/^[ \u3000]+/, s =>
            s.replace(/ /g, '\u00A0')
             .replace(/\u3000/g, '\u3000')
          );
          node.nodeValue = converted;
          break;
        }
        if (rest.length > 0) break;
      }
    });

    return wrapper.innerHTML;
  }

  function buildHtmlFromQuill() {
    if (!quill) return '';
    let raw = quill.root.innerHTML.replace(/\u200B|\uFEFF/g, '');
    const normalized = normalizeLeadingSpacesInBlocks(raw);
    const safeBody = DOMPurify.sanitize(normalized);
    const entityBody = safeBody
      .replace(/\u00A0/g, '&nbsp;')
      .replace(/\u3000/g, '&#12288;');

    return `${ARTICLE_STYLE}<div class="article-content">${entityBody}</div>`;
  }

// htmlContent å†…ã® <img src="data:image/..."> ã‚’
//   /photo/{basePrefix}/{basePrefix-01.png} å½¢å¼ã«å¤‰ãˆã¤ã¤
//   dataURL ã®é…åˆ—ã‚‚è¿”ã™
function processImagesInHtml(htmlContent, issueNumOrNull, slug) {
  const tmp = document.createElement("div");
  tmp.innerHTML = htmlContent;

  const body = tmp.querySelector(".article-content") || tmp;
  const imgs = body.querySelectorAll("img");

  // å·æ•°ãŒå–ã‚Œã‚Œã° "2168" ã®ã‚ˆã†ãª 4æ¡ã€ãã‚Œä»¥å¤–ã¯ slug ã‚’ä½¿ã†
  let basePrefix;
  if (issueNumOrNull != null) {
    const n = Number(issueNumOrNull) || 0;
    basePrefix = String(n).padStart(4, "0");
  } else {
    basePrefix = String(slug);
  }

  const imageInfos = [];
  let idx = 0;

  imgs.forEach(img => {
    const src = img.getAttribute("src") || "";
    if (!src.startsWith("data:image/")) return;

    idx++;
    const m = src.match(/^data:image\/([a-zA-Z0-9+.-]+);base64,/);
    let ext = (m && m[1] || "png").toLowerCase();
    if (ext === "jpeg" || ext === "pjpeg") ext = "jpg";

    const fileName = `${basePrefix}-${String(idx).padStart(2, "0")}.${ext}`;
    const uriPath  = `/photo/${basePrefix}/${fileName}`;

    imageInfos.push({
      basePrefix,
      fileName,
      uriPath,
      dataUrl: src
    });

    img.setAttribute("src", uriPath);
  });

  return {
    html: tmp.innerHTML,
    images: imageInfos,
    basePrefix
  };
}

// dataURL ã‹ã‚‰ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ GitHub ã«ä¿å­˜
async function saveImagesToGitHub(images, token) {
  for (const info of images) {
    const { basePrefix, fileName, dataUrl } = info;
    const path = `photo/${basePrefix}/${fileName}`; // ãƒ¬ãƒã‚¸ãƒˆãƒªä¸Šã®ãƒ‘ã‚¹

    const base64Data = dataUrl.split(",")[1] || "";
    if (!base64Data) continue;

    await githubUpsertBase64(path, base64Data, token, `Update image ${path}`);
    console.log("[GitHub] image saved:", path);
  }
}


  // â˜…â˜… ç”»åƒã® base64 ã‚’ /photo/{å·}/ãƒ•ã‚¡ã‚¤ãƒ«å ã«å·®ã—æ›¿ãˆã‚‹å‡¦ç† â˜…â˜…
  function processHtmlAndImages(issueRaw, slug, fullHtml) {
    // issueRaw: "2168" ãªã©ï¼ˆãªã‘ã‚Œã° slug ã‚’ä½¿ã†ï¼‰
    const digits = String(issueRaw || '').replace(/\D/g, '');
    const issueFolder = digits || slug;
    const baseName    = digits || slug;

    const parser = new DOMParser();
    const doc = parser.parseFromString(fullHtml, "text/html");

    const imgs = Array.from(doc.querySelectorAll('img'));
    const images = [];
    let index = 1;

    for (const img of imgs) {
      const src = img.getAttribute('src') || '';
      if (!src.startsWith('data:image/')) continue;

      const m = src.match(/^data:image\/(png|jpe?g|gif);base64,(.+)$/i);
      if (!m) continue;

      let ext = m[1].toLowerCase();
      if (ext === 'jpeg') ext = 'jpg';
      const b64 = m[2];

      const numStr = String(index).padStart(2, '0');
      const fileName = `${baseName}-${numStr}.${ext}`;
      const repoPath = `photo/${issueFolder}/${fileName}`;  // GitHub ä¸Šã®ãƒ‘ã‚¹
      const publicPath = `/photo/${issueFolder}/${fileName}`; // æœ¬ç•ªã‚µã‚¤ãƒˆã§ã®ãƒ‘ã‚¹

      images.push({
        path: repoPath,
        contentB64: b64
      });

      img.setAttribute('src', publicPath);
      index++;
    }

    // style ã¯ head ã«åˆ†é›¢ã•ã‚Œã‚‹ã®ã§ã€body éƒ¨åˆ†ã ã‘å–ã£ã¦å†åº¦ ARTICLE_STYLE ã‚’ä»˜ã‘ç›´ã™
    const bodyHtml = doc.body.innerHTML || '';
    const newHtml  = ARTICLE_STYLE + bodyHtml;

    return { html: newHtml, images };
  }

  // ã‚¿ã‚¤ãƒˆãƒ«/ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ç”¨ï¼š<br> or \n ã‚’æ”¹è¡Œã«
  function renderWithManualBreaks(raw) {
    if (!raw) return '';
    const escaped = raw
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
    return escaped
      .replace(/&lt;br\s*\/?&gt;/gi, '<br>')
      .replace(/\\n/g, '<br>');
  }

  // ===============================
  // 4. ãƒ•ã‚©ãƒ¼ãƒ å€¤ â†’ å…±é€šãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  // ===============================
  function getFormData() {
    const titleAndSubtitles = document.getElementById('titleAndSubtitles').value.trim();
    const [title, subtitle1, subtitle2] =
      titleAndSubtitles.split(/\r?\n/).map(s => s.trim());

    const isExceptional = document.getElementById('ä¾‹å¤–è¡¨ç¤º').checked;
    const isNewArticle  = document.getElementById('isNewArticle').checked;
    const isHiddenFlag  = document.getElementById('éè¡¨ç¤º').checked;

    const issueValue        = document.getElementById('issue').value.trim();
    const sequenceValue     = document.getElementById('sequence').value.trim();
    const publishDateValue  = document.getElementById('publishDate').value.trim();
    const publishDate = publishDateValue ? publishDateValue.replace(/-/g, '/') : '';

    const finalIssue = isNewArticle ? '' : issueValue;

    const issueNum    = !finalIssue
      ? null
      : (Number(finalIssue.replace(/[^\d.-]/g, '')) || null);
    const sequenceNum = sequenceValue
      ? (Number(sequenceValue.replace(/[^\d.-]/g, '')) || null)
      : null;

    // å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹å¤–è¡¨ç¤ºã®ã¨ãã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    if (!isExceptional) {
      if (!isNewArticle && !finalIssue) {
        setMessage('å·æ•°ã¯å¿…é ˆã§ã™ã€‚', true);
        return null;
      }
      if (!isNewArticle && !sequenceValue) {
        setMessage('æ²è¼‰é †ã¯å¿…é ˆã§ã™ã€‚', true);
        return null;
      }
      if (!publishDateValue) {
        setMessage('ç™ºè¡Œå¹´æœˆæ—¥ã¯å¿…é ˆã§ã™ã€‚', true);
        return null;
      }
      if (!titleAndSubtitles) {
        setMessage('è¨˜äº‹è¦‹å‡ºã—/ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™ã€‚', true);
        return null;
      }
    }

    const htmlContent = buildHtmlFromQuill();

    return {
      issue: finalIssue,
      sequence: sequenceValue,
      issueNum,
      sequenceNum,
      publishDate,
      title,
      subtitle1: subtitle1 || '',
      subtitle2: subtitle2 || '',
      categoryIds: selectedCategoryIds.slice(),
      keywords: document.getElementById('keywords').value
        .split(',')
        .map(k => k.trim())
        .filter(Boolean),
      htmlContent,
      isNewArticle,
      'ä¾‹å¤–è¡¨ç¤º': isExceptional,
      'éè¡¨ç¤º': isHiddenFlag,
      isHidden: isHiddenFlag
    };
  }

  // ===============================
  // 5. è¨˜äº‹IDï¼ˆslugï¼‰ç”Ÿæˆ
  // ===============================
  function randBase36(len = 6) {
    let s = '';
    while (s.length < len) s += Math.floor(Math.random() * 36).toString(36);
    return s.slice(0, len);
  }

  function buildArticleDocId(data) {
    if (data.isNewArticle) {
      const ymd = (data.publishDate || new Date().toISOString().slice(0,10))
        .replace(/[-/]/g, '');
      return `NEW-${ymd}-${Date.now().toString(36)}-${randBase36(6)}`;
    }
    const issue = String(data.issue || '').replace(/\D/g, '').padStart(4, '0');
    const seq   = String(data.sequence || '').replace(/\D/g, '').padStart(2, '0');
    if (!issue.trim() || !seq.trim()) return null;
    return `${issue}${seq}`;
  }

  // ===============================
  // 6. JSON ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ / èª­ã¿è¾¼ã¿
  // ===============================
  function downloadJson(docId, obj) {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${docId}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function setupJsonImport() {
    const input = document.getElementById('loadJsonFile');
    if (!input) return;

  console.log("[setupJsonImport] listener ã‚’è¨­å®šã—ã¾ã—ãŸ");

    input.addEventListener('change', async (e) => {
     console.log("[setupJsonImport] change ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«", e.target.files);


     const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);
      console.log("[setupJsonImport] JSON parse OK", data); // â† è¿½åŠ 


        fillFormFromJson(data, file.name.replace(/\.json$/i, ''));
        setMessage(`JSON ã‹ã‚‰è¨˜äº‹ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${file.name}ï¼‰ã€‚`);
      } catch (err) {
        console.error(err);
        setMessage('JSON ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
      } finally {
        // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¶šã‘ã¦é¸ã¹ã‚‹ã‚ˆã†ã«
        e.target.value = '';
      }
    });
  }

  function fillFormFromJson(data, fallbackId) {
    currentArticleId = data.slug || data.id || fallbackId || null;
    currentArticleCreatedAt = data.createdAt || null;

    // æ–°ç€
    const isNew = !!data.isNewArticle;
    const isEx  = !!(data['ä¾‹å¤–è¡¨ç¤º'] || data.exceptional);
    const isHidden = !!(data.isHidden || data['éè¡¨ç¤º']);

    const isNewCb = document.getElementById('isNewArticle');
    const exCb    = document.getElementById('ä¾‹å¤–è¡¨ç¤º');
    const hiddenCb= document.getElementById('éè¡¨ç¤º');

    if (isNewCb) isNewCb.checked = isNew;
    if (exCb)    exCb.checked    = isEx;
    if (hiddenCb)hiddenCb.checked= isHidden;

    toggleNewArticleUI(isNew);
    applyFormLocks();

    // å·æ•°ãƒ»æ²è¼‰é †ãƒ»æ—¥ä»˜
    const digits = String(data.issue || '').replace(/\D/g, '');
    const issue  = digits ? digits.padStart(4, '0') : (data.issue || '');
    document.getElementById('issue').value    = issue || '';
    document.getElementById('sequence').value = data.sequence || '';

    const rawDate   = data.publishDate || '';
    const inputDate = rawDate.replace(/\//g, '-');
    document.getElementById('publishDate').value = inputDate;

    // è¦‹å‡ºã—/ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«
    const mergedTitle = [data.title, data.subtitle1, data.subtitle2]
      .filter(s => s && String(s).trim() !== '')
      .join('\n');
    document.getElementById('titleAndSubtitles').value = mergedTitle;

    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    const kwEl = document.getElementById('keywords');
    if (kwEl) {
      if (Array.isArray(data.keywords)) {
        kwEl.value = data.keywords.join(', ');
      } else {
        kwEl.value = data.keywords || '';
      }
    }

    // æœ¬æ–‡ï¼ˆhtmlContentï¼‰
    if (typeof data.htmlContent === 'string' && data.htmlContent.trim()) {
      let bodyOnly = data.htmlContent.replace(/^[\s\S]*?<\/style>/i, '');
      bodyOnly = bodyOnly.replace(
        /^\s*<div[^>]*class=["'][^"']*article-content[^"']*["'][^>]*>([\s\S]*?)<\/div>\s*$/i,
        '$1'
      );
      const safe = DOMPurify.sanitize(bodyOnly);
      // å®Ÿä½“ã‚’æˆ»ã™
      const decoded = safe
        .replace(/&nbsp;/g, '\u00A0')
        .replace(/&#160;/g, '\u00A0')
        .replace(/&#xA0;/gi, '\u00A0')
        .replace(/&#12288;/g, '\u3000')
        .replace(/&#x3000;/gi, '\u3000');

      if (quill) {
        quill.root.innerHTML = decoded;
        quill.setSelection(0, 0, 'silent');
        quill.history.clear();
      }
    } else {
      if (quill) quill.setText('');
    }

    // ã‚«ãƒ†ã‚´ãƒª
    selectedCategoryIds = Array.isArray(data.categoryIds) ? data.categoryIds.slice() : [];
    updateCategoryDisplay();

    // ãƒœã‚¿ãƒ³çŠ¶æ…‹
    const updateBtn = document.getElementById('updateButton');
    const saveBtn   = document.getElementById('saveButton');
    if (updateBtn) {
      updateBtn.disabled = !currentArticleId;
    }
    if (saveBtn) {
      saveBtn.disabled = false; // æ–°ã—ã„IDã§å†ä¿å­˜ã‚‚ã§ãã‚‹
    }
  }


// ===== è¨˜äº‹ 1 æœ¬ã¶ã‚“ã‚’ JSON / BIN / ç”»åƒã«å±•é–‹ã—ã¦ GitHub ã«ä¿å­˜ =====
async function exportStaticFilesForArticle(slug, article, token) {
  // 0) å·æ•°ã¨æœ¬æ–‡HTMLã‚’ã“ã“ã§æ±ºã‚ã‚‹ï¼ˆâ˜… æ–°ã—ãè¿½åŠ ã—ãŸéƒ¨åˆ†ï¼‰
  //    ãƒ»ç”»åƒä¿å­˜ãƒ‘ã‚¹ç”¨ã«ã€Œå·æ•°ã€ã®æ•°å­—ã ã‘ã‚’å–ã‚Šå‡ºã™
  //    ãƒ»æœ¬æ–‡HTMLã¯ htmlContent å„ªå…ˆã€ãªã‘ã‚Œã° body / content ãªã©ã‹ã‚‰æ‹¾ã†
  const issueRaw = article.issue || article.issueNumber || "";
  const issueCode = String(issueRaw || "").replace(/\D/g, "") || "misc";

  const fullHtml =
    article.htmlContent ||  // ãµã ã‚“ã¯ã“ã“ã« Quill ã®HTMLãŒå…¥ã£ã¦ã„ã‚‹æƒ³å®š
    article.bodyHtml ||
    article.body ||
    article.content ||
    "";

  // 1) htmlContent å†…ã® data:image/... ã‚’ /photo/... ã«å·®ã—æ›¿ãˆã¤ã¤ã€
  //    ç”»åƒã® base64 ä¸€è¦§ã‚’å–å¾—
  const processed = processHtmlAndImages(issueCode, slug, fullHtml);
  article.htmlContent = processed.html;   // JSON ã«å…¥ã‚Œã‚‹æœ¬æ–‡ã¯ã“ã¡ã‚‰

  // 2) JSON ã¨ BIN ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
  const { jsonText, binText } = await buildJsonAndBin(slug, article);

  // 3) è¨˜äº‹ JSON ã‚’ GitHub ã«ã‚¢ãƒƒãƒ—
  const jsonB64 = textToBase64(jsonText);
  await githubPutFile(
    token,
    `build_plain_articles/${slug}.json`,
    jsonB64,
    `Add/update article ${slug}`
  );

  // 4) BIN ã‚‚ã‚ã‚Œã° GitHub ã«ã‚¢ãƒƒãƒ—ï¼ˆéµæœªè¨­å®šãªã‚‰ binText ã¯ nullï¼‰
  if (binText) {
    const binB64 = textToBase64(binText);
    await githubPutFile(
      token,
      `protected_enc/${slug}.bin`,
      binB64,
      `Add/update bin ${slug}`
    );
  }

  // 5) ç”»åƒã‚’ GitHub ã«ã‚¢ãƒƒãƒ—ï¼ˆ/photo/...ï¼‰
  for (const img of processed.images) {
    await githubPutFile(
      token,
      img.path,          // ä¾‹: "photo/2168/2168-01.png"
      img.contentB64,    // data:image/... ã‹ã‚‰åˆ‡ã‚Šå‡ºã—ãŸ base64 æœ¬ä½“
      `Add/update image for ${slug}: ${img.path}`
    );
  }
}

// ===============================
// ç™»éŒ²æ¸ˆã¿è¨˜äº‹ä¸€è¦§ã‚’ GitHub ã‹ã‚‰å–å¾—ã—ã¦ <select> ã«åæ˜ 
// ===============================
async function refreshArticleIdList() {
  const select = document.getElementById("articleIdList");
  if (!select) return;

  // ä¸€æ—¦åˆæœŸåŒ–
  select.innerHTML = `<option value="">-- è¨˜äº‹ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>`;

  let token;
  try {
    token = getGithubToken();   // â˜… å°æ–‡å­— getGithubTokenï¼ˆä»Šä½¿ã£ã¦ã„ã‚‹æ–¹ï¼‰
  } catch (e) {
    console.warn("[articleList] GitHub ãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®šã®ãŸã‚ä¸€è¦§ã¯èª­ã¿è¾¼ã¿ã¾ã›ã‚“ã€‚");
    return; // ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡ã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
  }

  try {
    // ãƒ¬ãƒã‚¸ãƒˆãƒªç›´ä¸‹ã® _manifest.json ã‚’å–å¾—
    const file = await githubGetFile("_manifest.json", token);
    if (!file) {
      console.warn("[articleList] _manifest.json ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    // Base64 â†’ JSON
    const rawB64 = (file.content || "").replace(/\n/g, "");
    const bin = atob(rawB64);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    const text = new TextDecoder().decode(bytes);

    const obj = JSON.parse(text);
    const list = Array.isArray(obj.files) ? obj.files.slice() : [];

    // è¡¨ç¤ºç”¨ã«ä¸¦ã³æ›¿ãˆï¼ˆç™ºè¡Œæ—¥é™é † â†’ slugé™é †ï¼‰
    list.sort((a, b) => {
      const ad = a.publishDate || "";
      const bd = b.publishDate || "";
      if (ad !== bd) return bd.localeCompare(ad);
      return String(b.slug).localeCompare(String(a.slug));
    });

    for (const f of list) {
      const opt = document.createElement("option");
      const date = f.publishDate || "";
      const title = f.title || f.slug;
      opt.value = f.slug;
      opt.textContent = date ? `${date}ï½œ${title}` : title;
      select.appendChild(opt);
    }
  } catch (e) {
    console.error("[articleList] ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
  }
}


// ===============================
// å…¨æ–‡æ¤œç´¢ç”¨ JSON ã®ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼
// ===============================

// htmlContent ã‹ã‚‰ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
function extractPlainTextFromHtml(html) {
  if (!html) return "";
  const tmp = document.createElement("div");
  tmp.innerHTML = html;
  // .article-content ãŒã‚ã‚Œã°ãã“ã ã‘ã€ãã‚Œä»¥å¤–ãªã‚‰å…¨ä½“
  const el = tmp.querySelector(".article-content") || tmp;
  const text = el.textContent || "";
  return text.replace(/\s+/g, " ").trim();
}

// 1è¨˜äº‹ã¶ã‚“ã‚’å…¨æ–‡æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
function buildSearchSourceEntry(slug, article) {
  const title     = article.title     || "";
  const subtitle1 = article.subtitle1 || "";
  const subtitle2 = article.subtitle2 || "";
  const keywords  = Array.isArray(article.keywords) ? article.keywords : [];
  const catIds    = Array.isArray(article.categoryIds) ? article.categoryIds : [];

  const bodyText  = extractPlainTextFromHtml(article.htmlContent || "");

  let text = [title, subtitle1, subtitle2, keywords.join(" "), bodyText]
    .join(" ")
    .replace(/\s+/g, " ")
    .trim();

  // ã‚ã¾ã‚Šã«ã‚‚é•·ããªã‚Šã™ãã‚‹ã®ã‚’é˜²ãï¼ˆ4,000æ–‡å­—ã§åˆ‡ã‚‹ï¼‰
  if (text.length > 4000) {
    text = text.slice(0, 4000);
  }

  // TinySegmenter ã§åˆ†ã‹ã¡æ›¸ãï¼ˆå¤±æ•—ã—ã¦ã‚‚ç„¡è¦–ï¼‰
  let tokens = [];
  try {
    if (typeof TinySegmenter === "function") {
      const seg = new TinySegmenter();
      tokens = seg.segment(text);
    }
  } catch (e) {
    console.warn("[searchSource] TinySegmenter ã§ã®åˆ†ã‹ã¡æ›¸ãã«å¤±æ•—:", e);
  }

  return {
    slug,
    issue: article.issue || "",
    publishDate: article.publishDate || "",
    title,
    subtitle1,
    subtitle2,
    keywords,
    categoryIds: catIds,
    isHidden: !!article.isHidden,
    isNewArticle: !!article.isNewArticle,
    text,
    tokens
  };
}

// ===============================
// å…¨æ–‡æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ GitHub ä¸Šã§å†ç”Ÿæˆ
//   ãƒ»_manifest.json ã‚’èª­ã¿è¾¼ã‚€
//   ãƒ»å…¨è¨˜äº‹ JSON ã‚’ GitHub ã‹ã‚‰å–å¾—
//   ãƒ»æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã—ã¦ SEARCH_SOURCE_PATH ã«ä¿å­˜
//   â†’ UI ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å‡ºã•ãšã€ä»¶æ•°ã‚’è¿”ã™
// ===============================
window.rebuildSearchSource = async function() {
  let token;
  try {
    token = getGithubToken();
  } catch (e) {
    // ãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®šã¯è‡´å‘½çš„ãªã®ã§ãã®ã¾ã¾æŠ•ã’ã‚‹
    throw new Error("GitHub ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆå…¨æ–‡æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã§ãã¾ã›ã‚“ï¼‰ã€‚");
  }

  // manifest ã‚’ãƒ­ãƒ¼ãƒ‰
  await ensureManifestLoaded(false, token);
  if (!Array.isArray(manifestFiles) || manifestFiles.length === 0) {
    throw new Error("manifest ãŒç©ºã®ãŸã‚ã€æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã§ãã¾ã›ã‚“ã€‚å…ˆã«è¨˜äº‹ã‚’æ›¸ãå‡ºã—ã¦ãã ã•ã„ã€‚");
  }

  const articles = [];

  // manifest ä¸Šã®å…¨è¨˜äº‹ã«ã¤ã„ã¦ JSON ã‚’ GitHub ã‹ã‚‰å–å¾—
  for (const f of manifestFiles) {
    const slug = String(f.slug || "").trim();
    if (!slug) continue;

    const path = `build_plain_articles/${encodeURIComponent(slug)}.json`;
    try {
      const file = await githubGetFile(path, token);
      if (!file) {
        console.warn("[searchSource] JSON ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", path);
        continue;
      }

      const rawB64 = (file.content || "").replace(/\n/g, "");
      const bin = atob(rawB64);
      const bytes = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
      const text = new TextDecoder().decode(bytes);
      const data = JSON.parse(text);

      const entry = buildSearchSourceEntry(slug, data);
      articles.push(entry);
    } catch (e) {
      console.error("[searchSource] è¨˜äº‹å–å¾—ã‚¨ãƒ©ãƒ¼:", path, e);
    }
  }

  // JSON ã‚’ GitHub ã«ä¿å­˜
  const payload = {
    version: 1,
    updatedAt: new Date().toISOString(),
    articles
  };
  const jsonText = JSON.stringify(payload, null, 2);
  const base64   = textToBase64(jsonText);

  await githubPutFile(
    token,
    SEARCH_SOURCE_PATH,
    base64,
    "Rebuild search source for full-text search"
  );

  console.log("[searchSource] å†ç”Ÿæˆå®Œäº†:", articles.length, "ä»¶");
  return articles.length;
};

// ===============================
// GitHub æ›¸ãè¾¼ã¿ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç®¡ç†
// ===============================
let isGitSaving = false;
let lastGitSaveAt = 0;
const GIT_SAVE_COOLDOWN_MS = 60 * 1000; // 60ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³

function openDeployBusyModal() {
  const modal = document.getElementById('deployBusyModal');
  if (modal) modal.style.display = 'flex';
}

window.closeDeployBusyModal = function () {
  const modal = document.getElementById('deployBusyModal');
  if (modal) modal.style.display = 'none';
};

/**
 * ä¿å­˜ãƒ»æ›´æ–°å‡¦ç†ã‚’é–‹å§‹ã—ã¦ã‚ˆã„ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
 * NG ã®ã¨ãã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‡ºã—ã¦ false ã‚’è¿”ã™
 */
function canStartGitSave() {
  const now = Date.now();

  // ã™ã§ã«ä¿å­˜å‡¦ç†ä¸­
  if (isGitSaving) {
    openDeployBusyModal();
    return false;
  }

  // ç›´è¿‘ã®ä¿å­˜ã‹ã‚‰ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­
  if (lastGitSaveAt && (now - lastGitSaveAt) < GIT_SAVE_COOLDOWN_MS) {
    openDeployBusyModal();
    return false;
  }

  // ä¿å­˜é–‹å§‹
  isGitSaving = true;
  return true;
}

/**
 * ä¿å­˜å‡¦ç†ã®çµ‚äº†ã‚’è¨˜éŒ²
 * @param {boolean} ok æˆåŠŸãªã‚‰ true
 */
function finishGitSave(ok) {
  isGitSaving = false;
  if (ok) {
    lastGitSaveAt = Date.now();
  }
}




// ===============================
// 7. ä¿å­˜ / æ›´æ–°ãƒœã‚¿ãƒ³ï¼ˆJSON/BIN + manifest ã‚’ GitHub ã«æ›¸ãå‡ºã—ï¼‰
// ===============================
window.saveArticle = async function() {

  // â˜… ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ / å¤šé‡æŠ¼ã—ã‚¬ãƒ¼ãƒ‰
  if (!canStartGitSave()) {
    return;
  }

 // â˜… ã“ã“ã§æœ€åˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
  setMessage("ä¿å­˜æº–å‚™ä¸­â€¦ï¼ˆGitHub ã¸æ›¸ãè¾¼ã¿ä¸­ã§ã™ï¼‰");

  try {
    const base = getFormData();
    if (!base) {
      // ãƒ•ã‚©ãƒ¼ãƒ ä¸å‚™ãªã© â†’ ä¿å­˜é–‹å§‹æ‰±ã„ã«ã¯ã—ãŸãŒã€å¤±æ•—ã¨ã—ã¦æ‰±ã†
      finishGitSave(false);
      return;
    }

    const token = getGithubToken();
    if (!token) {
      setMessage("GitHub ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
      finishGitSave(false);
      return;
    }

    const docId = buildArticleDocId(base);
    if (!docId) {
      setMessage('å·æ•°ã¨æ²è¼‰é †ã‹ã‚‰ ID ã‚’ä½œæˆã§ãã¾ã›ã‚“ï¼ˆæ–°ç€ä»¥å¤–ã¯ä¸¡æ–¹å¿…é ˆï¼‰ã€‚', true);
      finishGitSave(false);
      return;
    }

    const now = new Date().toISOString();
    const article = {
      ...base,
      id: docId,
      slug: docId,
      createdAt: now,
      updatedAt: now
    };

    // JSON / BIN / manifest æ›¸ãå‡ºã—
    await exportStaticFilesForArticle(docId, article, token);
    await updateManifestForArticle(docId, article, token);

    currentArticleId       = docId;
    currentArticleCreatedAt = article.createdAt;

    // â˜… è¨˜äº‹ä¿å­˜ãŒçµ‚ã‚ã£ãŸã‚‰ã€å…¨æ–‡æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿ã‚‚å†ç”Ÿæˆ
    try {
      const count = await window.rebuildSearchSource();
      setMessage(
        `GitHub ã«è¨˜äº‹ã‚’æ›¸ãå‡ºã—ã¾ã—ãŸï¼ˆ${docId}.json / ${docId}.bin â€»éµæœªè¨­å®šæ™‚ã¯ BIN ã‚¹ã‚­ãƒƒãƒ—ï¼‰ã€‚` +
        `å…¨æ–‡æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°ã—ã¾ã—ãŸï¼ˆ${count}ä»¶ï¼‰ã€‚`
      );
    } catch (e) {
      console.error("[saveArticle] searchSource æ›´æ–°ã‚¨ãƒ©ãƒ¼:", e);
      setMessage(
        `è¨˜äº‹ã¯ä¿å­˜ã§ãã¾ã—ãŸãŒã€å…¨æ–‡æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message || e}`,
        true
      );
    }

    // ã“ã“ã¾ã§æ¥ãŸã‚‰æˆåŠŸ
    finishGitSave(true);

  } catch (e) {
    console.error("[saveArticle] ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼:", e);
    setMessage(
      `GitHub ã¸ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message || e}`,
      true
    );
    finishGitSave(false);
  }
};



window.updateArticle = async function() {

  // â˜… ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ / å¤šé‡æŠ¼ã—ã‚¬ãƒ¼ãƒ‰
  if (!canStartGitSave()) {
    return;
  }

  try {
    if (!currentArticleId) {
      setMessage('æ›´æ–°å¯¾è±¡ã®è¨˜äº‹ ID ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã« JSON ã‚’èª­ã¿è¾¼ã‚€ã‹ã€æ–°è¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚', true);
      finishGitSave(false);
      return;
    }

    const base = getFormData();
    if (!base) {
      finishGitSave(false);
      return;
    }

    const token = getGithubToken();
    if (!token) {
      setMessage("GitHub ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
      finishGitSave(false);
      return;
    }

    const now = new Date().toISOString();
    const article = {
      ...base,
      id: currentArticleId,
      slug: currentArticleId,
      createdAt: currentArticleCreatedAt || now,
      updatedAt: now
    };

    await exportStaticFilesForArticle(currentArticleId, article, token);
    await updateManifestForArticle(currentArticleId, article, token);

    try {
      const count = await window.rebuildSearchSource();
      setMessage(
        `GitHub ä¸Šã®è¨˜äº‹ï¼ˆ${currentArticleId}ï¼‰ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆBIN ã¯éµæœªè¨­å®šæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰ã€‚` +
        `å…¨æ–‡æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°ã—ã¾ã—ãŸï¼ˆ${count}ä»¶ï¼‰ã€‚`
      );
    } catch (e) {
      console.error("[updateArticle] searchSource æ›´æ–°ã‚¨ãƒ©ãƒ¼:", e);
      setMessage(
        `è¨˜äº‹ã¯æ›´æ–°ã§ãã¾ã—ãŸãŒã€å…¨æ–‡æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message || e}`,
        true
      );
    }

    finishGitSave(true);

  } catch (e) {
    console.error("[updateArticle] æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼:", e);
    setMessage(
      `GitHub ã¸ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message || e}`,
      true
    );
    finishGitSave(false);
  }
};



  window.clearForm = function() {
    document.getElementById('issue').value = '';
    document.getElementById('sequence').value = '';
    document.getElementById('publishDate').value = '';
    document.getElementById('titleAndSubtitles').value = '';
    document.getElementById('keywords').value = '';
    document.getElementById('ä¾‹å¤–è¡¨ç¤º').checked = false;
    document.getElementById('éè¡¨ç¤º').checked = false;
    if (quill) quill.setText('');

    const select = document.getElementById('articleIdList');
    if (select) select.value = '';

    selectedCategoryIds = [];
    updateCategoryDisplay();

    const isNewCb = document.getElementById('isNewArticle');
    if (isNewCb) isNewCb.checked = false;
    toggleNewArticleUI(false);
    applyFormLocks();

    currentArticleId = null;
    currentArticleCreatedAt = null;

    setMessage('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã€æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã—ãŸã€‚');
  };

// ã€Œç™»éŒ²æ¸ˆã¿è¨˜äº‹ã®èª­ã¿è¾¼ã¿ã€ã® <select> ã‹ã‚‰å‘¼ã°ã‚Œã‚‹
window.loadArticleForEdit = async function(slug) {
  if (!slug) return;

  let token;
  try {
    token = getGithubToken();
  } catch (e) {
    alert("GitHub ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸Šéƒ¨ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  try {
    // build_plain_articles/{slug}.json ã‚’å–å¾—
    const path = `build_plain_articles/${encodeURIComponent(slug)}.json`;
    const file = await githubGetFile(path, token);
    if (!file) {
      alert(`GitHub ä¸Šã« ${path} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
      return;
    }

    const rawB64 = (file.content || "").replace(/\n/g, "");
    const bin = atob(rawB64);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    const text = new TextDecoder().decode(bytes);
    const data = JSON.parse(text);

    // æ—¢å­˜ã®ãƒ•ã‚©ãƒ¼ãƒ åæ˜ é–¢æ•°ã‚’å†åˆ©ç”¨
    fillFormFromJson(data, slug);
    setMessage(`GitHub ã‹ã‚‰è¨˜äº‹ï¼ˆ${slug}ï¼‰ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
  } catch (e) {
    console.error(e);
    alert(`è¨˜äº‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message || e}`);
  }
};

  // ===============================
  // 8. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  // ===============================
  window.previewArticle = function () {
    const fullHtml = buildHtmlFromQuill();
    document.getElementById('previewContent').innerHTML = fullHtml;

    const val = document.getElementById('titleAndSubtitles').value.trim().split(/\r?\n/);
    const [rawTitle, rawSub1, rawSub2] = [val[0]||'', val[1]||'', val[2]||''];

    document.getElementById('previewTitle').innerHTML = renderWithManualBreaks(rawTitle);
    document.getElementById('previewSubtitles').innerHTML = [
      renderWithManualBreaks(rawSub1),
      renderWithManualBreaks(rawSub2)
    ].join('<br>');

    document.getElementById('previewArea').style.display = 'flex';
  };

  window.closePreview = function() {
    document.getElementById('previewArea').style.display = 'none';
  };


  // ===============================
  // 9. ã‚«ãƒ†ã‚´ãƒªç®¡ç†ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰
  //    ãƒ»é †ç•ªä»˜ãã§ä¿æŒï¼ˆorderï¼‰
  //    ãƒ»â–² / â–¼ ã§ä¸¦ã³æ›¿ãˆå¯èƒ½
  // ===============================

  // [{ id, name, order }, ...]
  let categories = [];

  function getCategoryName(id) {
    const c = categories.find(c => c.id === id);
    return c ? c.name : id;
  }

  function loadCategoriesFromLocal() {
    try {
      const raw = localStorage.getItem('kjd_categories');
      const list = raw ? JSON.parse(raw) : [];

      if (Array.isArray(list)) {
        // æ—§å½¢å¼ {id,name} ã‚‚æ–°å½¢å¼ {id,name,order} ã‚‚ä¸¡æ–¹OKã«ã™ã‚‹
        categories = list
          .filter(c => c && c.id && c.name)
          .map((c, idx) => ({
            id: c.id,
            name: c.name,
            order: typeof c.order === 'number' ? c.order : idx
          }))
          .sort((a, b) => a.order - b.order);
      } else {
        categories = [];
      }
    } catch (e) {
      console.warn('[category] load error', e);
      categories = [];
    }
    renderCategoryUIs();
  }

  function saveCategoriesToLocal() {
    const list = categories.map((c, index) => ({
      id: c.id,
      name: c.name,
      order: index   // é…åˆ—ã®ä¸¦ã³ã‚’ãã®ã¾ã¾ä¿å­˜
    }));
    localStorage.setItem('kjd_categories', JSON.stringify(list));
  }

  function renderCategoryUIs() {
    const ul = document.getElementById('categoryListUl');
    const multiCheckboxes = document.getElementById('multiCategoryCheckboxes');
    if (!ul || !multiCheckboxes) return;

    ul.innerHTML = '';
    multiCheckboxes.innerHTML = '';

    categories.forEach((c, idx) => {
      // ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«å´ã®ãƒªã‚¹ãƒˆ
      const li = document.createElement('li');
      li.className = 'hover:bg-gray-50';
      li.innerHTML = `
        <span>${c.name}</span>
        <div class="flex gap-1">
          <button onclick="window.moveCategoryUp('${c.id}')" class="text-gray-500 hover:text-gray-700 text-xs px-1 border rounded">â–²</button>
          <button onclick="window.moveCategoryDown('${c.id}')" class="text-gray-500 hover:text-gray-700 text-xs px-1 border rounded">â–¼</button>
          <button onclick="window.deleteCategory('${c.id}')" class="text-red-500 hover:text-red-700 text-xs px-1 border rounded">å‰Šé™¤</button>
        </div>
      `;
      ul.appendChild(li);

      // è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«å´
      const div = document.createElement('div');
      div.className = 'flex items-center gap-2 p-1 border rounded hover:bg-blue-50 cursor-pointer';
      const isChecked = selectedCategoryIds.includes(c.id);
      div.innerHTML = `
        <input type="checkbox" class="category-checkbox" id="cat-${c.id}" value="${c.id}" ${isChecked ? 'checked' : ''}>
        <label for="cat-${c.id}">${c.name}</label>
      `;
      multiCheckboxes.appendChild(div);
    });

    updateCategoryDisplay();
  }

  window.updateCategoryDisplay = function() {
    const display = document.getElementById('selected-categories-display');
    if (!display) return;
    if (selectedCategoryIds.length > 0) {
      display.innerHTML = selectedCategoryIds.map(id =>
        `<span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded-full mr-1 mb-1">${getCategoryName(id)}</span>`
      ).join('');
      display.className = '';
    } else {
      display.textContent = "-- ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ --";
      display.className = "text-gray-500 text-sm";
    }
  };

  window.addCategory = function() {
    const nameInput = document.getElementById('newCategoryName');
    if (!nameInput) return;
    const name = nameInput.value.trim();
    if (!name) return;

    const id = `cat-${Date.now().toString(36)}-${randBase36(4)}`;
    categories.push({
      id,
      name,
      order: categories.length
    });
    saveCategoriesToLocal();
    renderCategoryUIs();

    nameInput.value = '';
    setMessage(`ã‚«ãƒ†ã‚´ãƒªã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
  };

  window.deleteCategory = function(id) {
    if (!confirm('æœ¬å½“ã«ã“ã®ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆã™ã§ã«ä»˜ã„ã¦ã„ã‚‹è¨˜äº‹ã®ã‚«ãƒ†ã‚´ãƒªIDã¯ãã®ã¾ã¾æ®‹ã‚Šã¾ã™ï¼‰')) return;
    categories = categories.filter(c => c.id !== id);
    selectedCategoryIds = selectedCategoryIds.filter(x => x !== id);
    saveCategoriesToLocal();
    renderCategoryUIs();
    setMessage('ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
  };

  window.moveCategoryUp = function(id) {
    const idx = categories.findIndex(c => c.id === id);
    if (idx <= 0) return;
    const tmp = categories[idx - 1];
    categories[idx - 1] = categories[idx];
    categories[idx] = tmp;
    saveCategoriesToLocal();
    renderCategoryUIs();
  };

  window.moveCategoryDown = function(id) {
    const idx = categories.findIndex(c => c.id === id);
    if (idx < 0 || idx >= categories.length - 1) return;
    const tmp = categories[idx + 1];
    categories[idx + 1] = categories[idx];
    categories[idx] = tmp;
    saveCategoriesToLocal();
    renderCategoryUIs();
  };

  window.openCategoryModal = function() {
    if (document.getElementById('category-selection-window').classList.contains('is-disabled')) return;
    document.getElementById('categoryModal').style.display = 'flex';
  };

  window.closeCategoryModal = function() {
    document.getElementById('categoryModal').style.display = 'none';
  };

  window.openMultiCategoryModal = function() {
    if (document.getElementById('category-selection-window').classList.contains('is-disabled')) return;
    // ç¾åœ¨ã®é¸æŠçŠ¶æ…‹ã‚’åæ˜ 
    document.querySelectorAll('.category-checkbox').forEach(cb => {
      cb.checked = selectedCategoryIds.includes(cb.value);
    });
    document.getElementById('multipleCategoryModal').style.display = 'flex';
  };

  window.closeMultiCategoryModal = function() {
    document.getElementById('multipleCategoryModal').style.display = 'none';
  };

  window.applyMultiCategories = function() {
    const next = [];
    document.querySelectorAll('.category-checkbox:checked').forEach(cb => next.push(cb.value));
    selectedCategoryIds = next;
    updateCategoryDisplay();
    window.closeMultiCategoryModal();
  };

  </script>



  <!-- ç¤¾å†…è¨˜äº‹ãƒªãƒ³ã‚¯ãƒ”ãƒƒã‚«ãƒ¼ï¼ˆUIã ã‘ã€‚ãƒ­ã‚¸ãƒƒã‚¯ã¯æœªå®Ÿè£…ã®ã¾ã¾ï¼‰ -->
  <div id="articleLinkPicker" class="alp-modal" style="display:none;">
    <div class="alp-panel">
      <div class="alp-header">
        <strong>ç¤¾å†…è¨˜äº‹ãƒªãƒ³ã‚¯ã‚’æŒ¿å…¥</strong>
        <button class="alp-close" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>

      <div class="alp-body">
        <div class="alp-row">
          <input id="alp-q" type="text" placeholder="å·æ•° / ã‚¿ã‚¤ãƒˆãƒ« / æ—¥ä»˜ï¼ˆä¾‹: 2153, 2024/08/08, ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰">
          <button id="alp-refresh" class="alp-btn">å†èª­è¾¼</button>
        </div>

        <div id="alp-list" class="alp-list">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

        <div class="alp-divider"></div>

        <details>
          <summary class="alp-muted">IDãŒæœªå®šï¼ˆæœªç™»éŒ²ï¼‰ã®å·ã§å…¥ã‚Œã‚‹ï¼ˆäºˆç´„ãƒªãƒ³ã‚¯ï¼‰</summary>
          <div class="alp-row" style="margin-top:8px;">
            <input id="alp-issue" type="text" placeholder="No.1902 ã®ã‚ˆã†ã«å·æ•°ã ã‘">
            <button id="alp-insert-issue" class="alp-btn">No.ãƒªãƒ³ã‚¯ã‚’æŒ¿å…¥</button>
          </div>
          <div class="alp-help">â€» é–²è¦§å´ã§ã¯è©²å½“å·ã®è¨˜äº‹é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå‡ºã¾ã™ï¼ˆè¨˜äº‹ãŒ1æœ¬ã ã‘ãªã‚‰å³è¡¨ç¤ºï¼‰ã€‚</div>
        </details>
      </div>
    </div>
  </div>

  <style>
  .alp-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;display:flex;align-items:center;justify-content:center}
  .alp-panel{width:min(760px,95vw);max-height:85vh;overflow:auto;background:#fff;border-radius:12px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .alp-header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e7eb}
  .alp-close{border:0;background:transparent;font-size:20px;cursor:pointer}
  .alp-body{padding:12px}
  .alp-row{display:flex;gap:8px;align-items:center}
  .alp-row input{flex:1 1 auto;padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px}
  .alp-btn{padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer}
  .alp-list{margin-top:10px;border:1px solid #e5e7eb;border-radius:8px;max-height:48vh;overflow:auto}
  .alp-item{display:flex;justify-content:space-between;gap:8px;padding:10px;border-bottom:1px solid #f1f5f9}
  .alp-item:last-child{border-bottom:none}
  .alp-item-main{min-width:0}
  .alp-title{font-weight:600}
  .alp-meta{font-size:12px;color:#64748b;margin-top:2px}
  .alp-insert{white-space:nowrap}
  .alp-muted{color:#6b7280}
  .alp-divider{height:1px;background:#e5e7eb;margin:12px 0}
  .alp-help{font-size:12px;color:#6b7280;margin-top:4px}
  </style>

<!-- GitHub æ›¸ãè¾¼ã¿ä¸­ã®è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="deployBusyModal" class="deploy-modal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#fff;
    padding:20px;
    max-width:420px;
    width:90%;
    border-radius:8px;
    box-shadow:0 4px 15px rgba(0,0,0,.3);
  ">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <strong>ä¿å­˜å‡¦ç†ã®å¾…æ©Ÿä¸­ã§ã™</strong>
      <button type="button" onclick="closeDeployBusyModal()" style="
        border:none;
        background:transparent;
        font-size:18px;
        cursor:pointer;
      ">Ã—</button>
    </div>
    <p style="font-size:14px; line-height:1.5;">
      ç¾åœ¨ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ GitHub ã¸ã®æ›¸ãè¾¼ã¿å‡¦ç†ãŒé€²è¡Œä¸­ã§ã™ã€‚<br>
      ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã™ã‚‹ã¾ã§ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚
    </p>
  </div>
</div>



</body>
</html>
